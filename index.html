<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheetrock Counter Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

    <!-- Main Container -->
    <div class="max-w-xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-1">Sheetrock Tally</h1>
            <p class="text-gray-500">Tap to count sheets. Saves automatically.</p>
        </header>

        <!-- User ID Display -->
        <div id="auth-status" class="bg-indigo-50 border border-indigo-200 p-3 rounded-xl mb-6 shadow-sm text-sm">
            <p class="font-semibold text-indigo-700">User ID:</p>
            <p id="user-id" class="text-indigo-800 break-all font-mono text-xs mt-1">Authenticating...</p>
        </div>

        <!-- Project Details Input Form -->
        <div class="bg-white p-5 rounded-xl shadow-lg mb-6 space-y-4">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2">Project Details</h2>
            
            <div class="relative">
                <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                <input type="text" id="customer-name" data-field="customerName" placeholder="e.g., Jane Doe"
                       class="project-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100" disabled>
            </div>

            <div class="relative">
                <label for="site-address" class="block text-sm font-medium text-gray-700">Site Address</label>
                <input type="text" id="site-address" data-field="siteAddress" placeholder="e.g., 123 Main St, Anytown"
                       class="project-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100" disabled>
            </div>
        </div>


        <!-- Sheetrock Size Counters -->
        <div id="sheetrock-counters" class="space-y-4 mb-8">
            <!-- Counters will be injected here by JavaScript -->
        </div>

        <!-- Total Summary and Reset Button -->
        <div class="mt-8 pt-4 border-t border-gray-200 flex flex-col space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Total Sheets:</h2>
                <div class="text-3xl font-extrabold text-gray-900" id="grand-total">0</div>
            </div>
            
            <div class="flex justify-between items-center bg-indigo-100 p-3 rounded-xl">
                <h2 class="text-xl font-bold text-indigo-800">Total Square Footage:</h2>
                <div class="text-2xl font-extrabold text-indigo-900" id="total-sqft">0 Sq. Ft.</div>
            </div>

            <button id="reset-button" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                Reset ALL Counts & Project Data
            </button>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Constants for Firestore
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const COLLECTION_NAME = 'sheetrock_counts';
        const DOCUMENT_ID = 'sheetrock_inventory';

        // Sheetrock sizes and their corresponding square footage (in sq. ft.)
        // Assumption: 5/8" Fire and 1/2" Regular are standard 4x8 (32 sqft)
        const SHEETROCK_DIMENSIONS = {
            '4x8': 32,
            '4x10': 40,
            '4x12': 48,
            '5/8" Fire': 32, // Assumed 4x8
            '1/2" Regular': 32, // Assumed 4x8
            'Moisture': 40, // User specified: 4x10
            'Stretch': 54  // User specified: 4.5x12
        };
        const SHEETROCK_SIZES = Object.keys(SHEETROCK_DIMENSIONS);


        // --- Utility Functions ---

        /**
         * Safely gets the Firestore document path for the current user.
         * @returns {object} The document reference.
         */
        function getDocumentRef() {
            if (!db || !userId) {
                console.error("Database or User ID is not initialized.");
                return null;
            }
            // Use private storage path: /artifacts/{appId}/users/{userId}/sheetrock_counts/sheetrock_inventory
            return doc(db, 'artifacts', appId, 'users', userId, COLLECTION_NAME, DOCUMENT_ID);
        }

        // --- UI Rendering ---

        /**
         * Renders a single counter component for a given sheet size.
         * @param {string} size - The sheet size (e.g., '4x8').
         * @param {number} count - The current count.
         */
        function renderCounter(size, count) {
            const container = document.getElementById('sheetrock-counters');
            const safeSizeId = size.replace(/[^a-zA-Z0-9]/g, '_').replace(/"/g, 'in').replace('/', 'slash'); // Sanitized ID
            let counterElement = document.getElementById(`counter-${safeSizeId}`);

            // Determine specific color for Moisture/Stretch for visual distinction
            let plusClass = 'bg-green-500 hover:bg-green-600 text-white';
            if (size === 'Moisture') {
                 plusClass = 'bg-blue-500 hover:bg-blue-600 text-white';
            } else if (size === 'Stretch') {
                 plusClass = 'bg-yellow-500 hover:bg-yellow-600 text-gray-900';
            }
            
            // If the element doesn't exist, create it
            if (!counterElement) {
                counterElement = document.createElement('div');
                counterElement.id = `counter-${safeSizeId}`;
                counterElement.className = 'flex items-center justify-between bg-white p-4 rounded-xl shadow-lg';
                counterElement.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-lg font-bold text-gray-700">${size}</span>
                        <span class="text-xs text-gray-400">${SHEETROCK_DIMENSIONS[size] || 0} sq. ft.</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Minus Button -->
                        <button id="minus-${safeSizeId}" data-size="${size}" data-action="decrement"
                            class="control-btn bg-red-100 hover:bg-red-200 text-red-600 w-12 h-12 text-2xl font-bold rounded-full transition-colors active:scale-95 disabled:opacity-30" disabled>
                            &minus;
                        </button>

                        <!-- Count Display -->
                        <span id="count-${safeSizeId}" class="text-4xl font-extrabold text-gray-900 w-16 text-center">${count}</span>

                        <!-- Plus Button -->
                        <button id="plus-${safeSizeId}" data-size="${size}" data-action="increment"
                            class="control-btn ${plusClass} w-12 h-12 text-2xl font-bold rounded-full transition-colors active:scale-95 disabled:opacity-50" disabled>
                            &plus;
                        </button>
                    </div>
                `;
                container.appendChild(counterElement);

                // Add event listeners once
                counterElement.querySelectorAll('.control-btn').forEach(button => {
                    button.addEventListener('click', handleCounterClick);
                });
            } else {
                // If element exists, just update the count display
                document.getElementById(`count-${safeSizeId}`).textContent = count;
            }
        }

        /**
         * Updates the UI buttons and project inputs' disabled state based on auth status.
         * @param {boolean} ready - True if auth is complete and inputs/buttons should be enabled.
         */
        function updateUIStates(ready) {
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = !ready);
            document.getElementById('reset-button').disabled = !ready;
            document.querySelectorAll('.project-input').forEach(input => input.disabled = !ready);
        }

        // --- Firestore Interaction Handlers ---

        /**
         * Initializes the Sheetrock counter document with default values if it doesn't exist.
         */
        async function initializeCounterDocument() {
            const docRef = getDocumentRef();
            if (!docRef) return;

            // Create an object with all counts initialized to 0 and project details empty
            const initialData = {
                customerName: '',
                siteAddress: '',
                userId: userId
            };
            SHEETROCK_SIZES.forEach(size => {
                initialData[size] = 0;
            });

            try {
                // Use setDoc with { merge: true } to create if it doesn't exist, or merge if it does.
                await setDoc(docRef, initialData, { merge: true });
            } catch (error) {
                console.error("Error initializing document:", error);
            }
        }

        /**
         * Handles saving changes from the project input fields (Customer Name, Address).
         * @param {Event} event - The input change event.
         */
        async function handleInputChange(event) {
            if (!isAuthReady) return;

            const input = event.currentTarget;
            const field = input.dataset.field;
            const value = input.value.trim();
            const docRef = getDocumentRef();
            if (!docRef) return;

            try {
                const update = {};
                update[field] = value;
                await updateDoc(docRef, update);
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
            }
        }

        /**
         * Handles the click on the plus/minus buttons.
         * @param {Event} event - The click event.
         */
        async function handleCounterClick(event) {
            if (!isAuthReady) return;

            const button = event.currentTarget;
            const size = button.dataset.size;
            const action = button.dataset.action;
            const docRef = getDocumentRef();
            if (!docRef) return;

            try {
                // Temporarily disable the button to prevent rapid-fire clicks
                button.disabled = true;

                // Get current count from the UI (which is updated by onSnapshot)
                const safeSizeId = size.replace(/[^a-zA-Z0-9]/g, '_').replace(/"/g, 'in').replace('/', 'slash');
                const currentCountElement = document.getElementById(`count-${safeSizeId}`);
                let currentCount = parseInt(currentCountElement.textContent) || 0;
                let newCount = currentCount;


                if (action === 'increment') {
                    newCount++;
                } else if (action === 'decrement' && currentCount > 0) {
                    newCount--;
                } else if (action === 'decrement' && currentCount === 0) {
                    // Prevent writing a negative number to the database
                    button.disabled = false;
                    return;
                }

                const update = {};
                update[size] = newCount;
                await updateDoc(docRef, update);
                button.disabled = false; // Re-enable on success

            } catch (error) {
                console.error("Error updating counter:", error);
                button.disabled = false;
            }
        }

        /**
         * Resets all counts and project details to zero/empty.
         */
        async function resetAllCounts() {
            if (!isAuthReady || !confirm('Are you sure you want to reset ALL sheetrock counts and project details to zero?')) return;

            const docRef = getDocumentRef();
            if (!docRef) return;

            try {
                const resetData = { customerName: '', siteAddress: '' };
                SHEETROCK_SIZES.forEach(size => {
                    resetData[size] = 0;
                });
                await updateDoc(docRef, resetData);
                console.log("All counts and project data reset successfully.");
            } catch (error) {
                console.error("Error resetting counts:", error);
            }
        }

        // --- Real-time Listener and Calculation ---

        /**
         * Sets up the real-time listener for the sheetrock counts.
         */
        function startRealtimeListener() {
            const docRef = getDocumentRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let totalSheets = 0;
                    let totalSqFt = 0;

                    // 1. Update Project Details
                    document.getElementById('customer-name').value = data.customerName || '';
                    document.getElementById('site-address').value = data.siteAddress || '';


                    // 2. Update Counters and Calculate Totals
                    SHEETROCK_SIZES.forEach(size => {
                        // Use 0 if the key is missing or undefined
                        const count = data[size] !== undefined ? data[size] : 0;
                        const sqFtPerSheet = SHEETROCK_DIMENSIONS[size] || 0;

                        renderCounter(size, count);
                        totalSheets += count;
                        totalSqFt += count * sqFtPerSheet;

                        // Also update the disabled state of the minus button if count is 0
                        const safeSizeId = size.replace(/[^a-zA-Z0-9]/g, '_').replace(/"/g, 'in').replace('/', 'slash');
                        const minusBtn = document.getElementById(`minus-${safeSizeId}`);
                        if (minusBtn) {
                            minusBtn.disabled = count <= 0 || !isAuthReady;
                        }
                    });

                    // 3. Update Totals Display
                    document.getElementById('grand-total').textContent = totalSheets;
                    document.getElementById('total-sqft').textContent = totalSqFt.toLocaleString() + ' Sq. Ft.';

                } else {
                    // Document doesn't exist, initialize it
                    initializeCounterDocument();
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
            });
        }

        // --- Initialization and Auth ---

        window.onload = function () {
            // 1. Initialize Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // For visibility into Firestore activity
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('auth-status').innerHTML = '<p class="text-red-600">Firebase Init Error. Check console.</p>';
                return;
            }

            // 2. Attach Listeners
            document.getElementById('reset-button').addEventListener('click', resetAllCounts);
            document.querySelectorAll('.project-input').forEach(input => {
                // Use 'change' event to save on blur/enter (standard form behavior)
                input.addEventListener('change', handleInputChange);
            });

            // 3. Set up Auth Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;

                    document.getElementById('user-id').textContent = userId;
                    document.getElementById('auth-status').classList.remove('bg-indigo-50');
                    document.getElementById('auth-status').classList.add('bg-green-50');
                    document.getElementById('auth-status').querySelector('p').textContent = 'Authenticated User ID:';

                    // 4. Render initial static elements and enable UI
                    SHEETROCK_SIZES.forEach(size => renderCounter(size, 0));
                    updateUIStates(true);

                    // 5. Start listening for data
                    startRealtimeListener();

                } else {
                    // Attempt to sign in if no user is found
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom Token Sign In failed, falling back:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        };
    </script>
</body>
</html>

